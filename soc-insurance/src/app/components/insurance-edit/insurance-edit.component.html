<mat-card>
  <mat-card-title>保険料編集</mat-card-title>
  <mat-card-content>
    <form [formGroup]="form" (ngSubmit)="onSave()">
      <div class="info-row">
        <div class="info-label">氏名</div>
        <div class="info-value">{{ data?.fullName }}</div>
        <div class="info-label">社員番号</div>
        <div class="info-value">{{ data?.employeeId }}</div>
        <div class="info-label">対象月</div>
        <div class="info-value">{{ data?.period ? (data.period.year + '年' + data.period.month + '月') : '' }}</div>
        <div class="info-label">所属</div>
        <div class="info-value">{{ data?.department }}</div>
        <div class="info-label">等級</div>
        <div class="info-value">
          <ng-container *ngIf="insuranceStatus?.grade !== null && insuranceStatus?.grade !== undefined && insuranceStatus?.grade !== '' && insuranceStatus?.grade !== 0 && insuranceStatus?.grade !== '未設定'; else notSet">
            {{ insuranceStatus?.grade }}
          </ng-container>
          <ng-template #notSet>
            <span style="color: red;">従業員管理ページで等級を設定してください</span>
          </ng-template>
        </div>
      </div>
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>基本給</mat-label>
          <input matInput type="number" formControlName="baseSalary">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>手当</mat-label>
          <input matInput type="number" formControlName="allowances" min="0">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>通勤手当</mat-label>
          <input matInput type="number" formControlName="commutingAllowance" min="0">
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>賞与</mat-label>
          <input matInput type="number" formControlName="bonusAmount" min="0">
        </mat-form-field>
      </div>
      <div class="row">
        <mat-form-field appearance="outline">
          <mat-label>標準報酬月額</mat-label>
          <input matInput [value]="standardMonthlyWage !== null ? (standardMonthlyWage | number:'1.0-0') : ''" readonly>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>報酬月額</mat-label>
          <input matInput [value]="data?.standardMonthlyRemuneration | number:'1.0-0'" readonly>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>標準賞与額</mat-label>
          <input matInput [value]="form.get('standardBonusAmount')?.value !== null ? (form.get('standardBonusAmount')?.value | number:'1.0-0') : ''" readonly>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>健康保険料率</mat-label>
          <input matInput [value]="data?.healthInsuranceRate || '自動計算'" readonly>
        </mat-form-field>
      </div>
      <div class="row">
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <tr>
            <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">項目</th>
            <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">個人分（円）</th>
            <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">会社分（円）</th>
          </tr>
          <tr>
            <td style="border: 1px solid #888; padding: 6px;">健康保険料</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.healthInsuranceEmployee?.toLocaleString() || '0') }}</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.healthInsuranceEmployer?.toLocaleString() || '0') }}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #888; padding: 6px;">介護保険料</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.nursingInsuranceEmployee?.toLocaleString() || '0') }}</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.nursingInsuranceEmployer?.toLocaleString() || '0') }}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #888; padding: 6px;">厚生年金保険料</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.pensionInsuranceEmployee?.toLocaleString() || '0') }}</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.pensionInsuranceEmployer?.toLocaleString() || '0') }}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #888; padding: 6px;">子ども・子育て拠出金</td>
            <td style="border: 1px solid #888; padding: 6px;">0</td>
            <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (data?.childContribution?.toLocaleString() || '0') }}</td>
          </tr>
          <tr>
            <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">合計</td>
            <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">{{ isChildCareLeave ? '0' : (roundAmount(data?.employeeTotalDeduction || 0) | number:'1.0-0') }}</td>
            <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">{{ isChildCareLeave ? '0' : (roundAmount((data?.healthInsuranceEmployer || 0) + (data?.nursingInsuranceEmployer || 0) + (data?.pensionInsuranceEmployer || 0)) | number:'1.0-0') }}</td>
          </tr>
        </table>
      </div>
      <!-- 賞与用保険料計算表（賞与支給月のみ表示） -->
      <div *ngIf="isBonusMonth && bonusCount && bonusCount <= 3 && form.get('standardBonusAmount')?.value > 0">
        <h3>賞与保険料計算</h3>
        <table class="bonus-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">項目</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">個人分（円）</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">会社分（円）</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">健康保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.healthInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.healthInsuranceEmployer | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">介護保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.nursingInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.nursingInsuranceEmployer | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">厚生年金保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.pensionInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.pensionInsuranceEmployer | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">子ども・子育て拠出金</td>
              <td style="border: 1px solid #888; padding: 6px;">0</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ isChildCareLeave ? '0' : (bonusInsuranceResult?.childContribution?.toLocaleString() || '0') }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">合計</td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{
                  (bonusInsuranceResult?.healthInsuranceEmployee || 0)
                  + (bonusInsuranceResult?.nursingInsuranceEmployee || 0)
                  + (bonusInsuranceResult?.pensionInsuranceEmployee || 0)
                | number:'1.0-0'}}
              </td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{
                  (bonusInsuranceResult?.healthInsuranceEmployer || 0)
                  + (bonusInsuranceResult?.nursingInsuranceEmployer || 0)
                  + (bonusInsuranceResult?.pensionInsuranceEmployer || 0)
                | number:'1.0-0'}}
              </td>
            </tr>
          </tbody>
        </table>
        <!-- 給与分＋賞与分の社会保険料合計（個人分） -->
        <div style="font-weight: bold; margin-top: 16px;">社会保険料合計（個人分）</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 10px;">
          <thead>
            <tr>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">項目</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">給与分</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">賞与分</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">合計</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">健康保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ data?.healthInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.healthInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.healthInsuranceEmployee || 0) + (bonusInsuranceResult?.healthInsuranceEmployee || 0)) | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">介護保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ data?.nursingInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.nursingInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.nursingInsuranceEmployee || 0) + (bonusInsuranceResult?.nursingInsuranceEmployee || 0)) | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">厚生年金保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ data?.pensionInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.pensionInsuranceEmployee | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.pensionInsuranceEmployee || 0) + (bonusInsuranceResult?.pensionInsuranceEmployee || 0)) | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">合計</td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{ ((data?.healthInsuranceEmployee || 0) + (data?.nursingInsuranceEmployee || 0) + (data?.pensionInsuranceEmployee || 0)) | number:'1.0-0' }}
              </td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{ ((bonusInsuranceResult?.healthInsuranceEmployee || 0) + (bonusInsuranceResult?.nursingInsuranceEmployee || 0) + (bonusInsuranceResult?.pensionInsuranceEmployee || 0)) | number:'1.0-0' }}
              </td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{ ((data?.healthInsuranceEmployee || 0) + (data?.nursingInsuranceEmployee || 0) + (data?.pensionInsuranceEmployee || 0) + (bonusInsuranceResult?.healthInsuranceEmployee || 0) + (bonusInsuranceResult?.nursingInsuranceEmployee || 0) + (bonusInsuranceResult?.pensionInsuranceEmployee || 0)) | number:'1.0-0' }}
              </td>
            </tr>
          </tbody>
        </table>
        <!-- 給与分＋賞与分の社会保険料合計（会社分） -->
        <div style="font-weight: bold; margin-top: 16px;">社会保険料合計（会社分）</div>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">項目</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">給与分</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">賞与分</th>
              <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5;">合計</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">健康保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ data?.healthInsuranceEmployer | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.healthInsuranceEmployer | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.healthInsuranceEmployer || 0) + (bonusInsuranceResult?.healthInsuranceEmployer || 0)) | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">介護保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ data?.nursingInsuranceEmployer | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.nursingInsuranceEmployer | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.nursingInsuranceEmployer || 0) + (bonusInsuranceResult?.nursingInsuranceEmployer || 0)) | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px;">厚生年金保険料</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ data?.pensionInsuranceEmployer | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ bonusInsuranceResult?.pensionInsuranceEmployer | number:'1.0-0' }}</td>
              <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.pensionInsuranceEmployer || 0) + (bonusInsuranceResult?.pensionInsuranceEmployer || 0)) | number:'1.0-0' }}</td>
            </tr>
            <tr>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">合計</td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{ ((data?.healthInsuranceEmployer || 0) + (data?.nursingInsuranceEmployer || 0) + (data?.pensionInsuranceEmployer || 0)) | number:'1.0-0' }}
              </td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{ ((bonusInsuranceResult?.healthInsuranceEmployer || 0) + (bonusInsuranceResult?.nursingInsuranceEmployer || 0) + (bonusInsuranceResult?.pensionInsuranceEmployer || 0)) | number:'1.0-0' }}
              </td>
              <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
                {{ ((data?.healthInsuranceEmployer || 0) + (data?.nursingInsuranceEmployer || 0) + (data?.pensionInsuranceEmployer || 0) + (bonusInsuranceResult?.healthInsuranceEmployer || 0) + (bonusInsuranceResult?.nursingInsuranceEmployer || 0) + (bonusInsuranceResult?.pensionInsuranceEmployer || 0)) | number:'1.0-0' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="row">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>備考</mat-label>
          <textarea matInput formControlName="notes" rows="2"></textarea>
        </mat-form-field>
      </div>
      <div class="button-container">
        <button mat-raised-button color="primary" (click)="onSave()"
          [disabled]="!employmentInfo?.grade || employmentInfo?.grade === '' || employmentInfo?.grade === 0">
          保存
        </button>
        <button mat-raised-button (click)="onBack()">戻る</button>
      </div>
    </form>
  </mat-card-content>
</mat-card>

<!-- PDF出力用のテンプレート -->
<div #pdfContent style="display: none;">
  <div style="padding: 20px; font-family: 'Noto Sans JP', sans-serif;">
    <h1 style="text-align: center; font-size: 20px; margin-bottom: 30px;">
      社会保険料明細書　
      {{data?.period ? (data.period.year + '年' + data.period.month + '月') : ''}}　
      {{data?.fullName || ''}}　
      {{data?.employeeId || ''}}
    </h1>
    <div style="margin-bottom: 10px; font-size: 14px;">
      <strong>等級：</strong> {{ insuranceStatus?.grade }}
    </div>
    
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
      <tr>
        <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">項目</th>
        <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">金額</th>
        <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">項目</th>
        <th style="border: 1px solid #888; padding: 6px; background: #f5f5f5; width: 25%;">金額</th>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px;">報酬月額</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.standardMonthlyRemuneration?.toLocaleString() || '0'}}円</td>
        <td style="border: 1px solid #888; padding: 6px;">賞与支給額（該当月）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.bonusAmount?.toLocaleString() || '0'}}円</td>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px;">標準報酬月額</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.standardMonthlyWage?.toLocaleString() || '0'}}円</td>
        <td style="border: 1px solid #888; padding: 6px;">標準賞与額</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.standardBonusAmount?.toLocaleString() || '0'}}円</td>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px;">健康保険料（個人分）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.healthInsuranceEmployee?.toLocaleString() || '0'}}円</td>
        <td style="border: 1px solid #888; padding: 6px;">健康保険料（会社分）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.healthInsuranceEmployer?.toLocaleString() || '0'}}円</td>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px;">介護保険料（個人分）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.nursingInsuranceEmployee?.toLocaleString() || '0'}}円</td>
        <td style="border: 1px solid #888; padding: 6px;">介護保険料（会社分）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.nursingInsuranceEmployer?.toLocaleString() || '0'}}円</td>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px;">厚生年金保険料（個人分）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.pensionInsuranceEmployee?.toLocaleString() || '0'}}円</td>
        <td style="border: 1px solid #888; padding: 6px;">厚生年金保険料（会社分）</td>
        <td style="border: 1px solid #888; padding: 6px;">{{data?.pensionInsuranceEmployer?.toLocaleString() || '0'}}円</td>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px;">子ども・子育て拠出金</td>
        <td style="border: 1px solid #888; padding: 6px;">{{ ((data?.healthInsuranceEmployer || 0) * 0.0036).toLocaleString() || '0' }}円</td>
        <td style="border: 1px solid #888; padding: 6px;"></td>
        <td style="border: 1px solid #888; padding: 6px;"></td>
      </tr>
      <tr>
        <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">個人負担保険料合計</td>
        <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">{{roundAmount(data?.employeeTotalDeduction || 0) | number:'1.0-0'}}円</td>
        <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">会社負担保険料合計</td>
        <td style="border: 1px solid #888; padding: 6px; font-weight: bold; background: #f5f5f5;">
          {{
            roundAmount(
              (data?.healthInsuranceEmployer || 0)
              + (data?.nursingInsuranceEmployer || 0)
              + (data?.pensionInsuranceEmployer || 0)
            ) | number:'1.0-0'
          }}円
        </td>
      </tr>
    </table>

    <div style="margin-bottom: 10px; font-size: 14px;">
      <strong>備考：</strong> {{data?.notes || ''}}
    </div>

    <div style="margin-top: 30px; font-size: 12px;">
      <p>出力日時: {{today | date:'yyyy年MM月dd日 HH:mm'}}</p>
    </div>
  </div>
</div> 